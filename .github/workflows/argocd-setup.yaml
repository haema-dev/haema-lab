name: "Step 2: ArgoCD Bootstrapping"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/argocd-setup.yaml"

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ—ï¸ Declarative ArgoCD & Infrastructure Setup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure Sanity Check"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            # 1. ë°©í™”ë²½ ì ê²€: í†µì‹  ì¥ì• ì˜ ì£¼ë²”ì¸ UFWë¥¼ ë¹„í™œì„±í™”í•˜ê±°ë‚˜ í•„ìˆ˜ í¬íŠ¸ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
            sudo ufw disable || true

            # 2. MTU ì ê²€: Calico ConfigMapì´ 1220ì¸ì§€ ìƒì‹œ í™•ì¸í•˜ê³  íŒ¨ì¹˜í•©ë‹ˆë‹¤.
            kubectl patch cm -n kube-system calico-config --type merge \
              -p '{"data": {"veth_mtu": "1220"}}' || true

            echo "ğŸš€ Phase 2: Declarative Resource Sync"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # 1. StorageClass: ì„ ì–¸ì ìœ¼ë¡œ ì ìš© (ì´ë¯¸ ìˆìœ¼ë©´ ìœ ì§€)
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

            # 2. Namespaces: ì‚­ì œ ì—†ì´ ìƒì„± ì‹œë„ (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
            kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

            # 3. ArgoCD Installation: Server-side applyë¡œ ë³€ê²½ ì‚¬í•­ë§Œ ë°˜ì˜
            kubectl apply --server-side --force-conflicts -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.10.4/manifests/install.yaml

            # 4. Secrets Sync: ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
            kubectl create secret generic argocd-redis -n argocd --from-literal=auth='' --dry-run=client -o yaml | kubectl apply -f -
            kubectl create secret generic grafana-admin-credentials -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' --dry-run=client -o yaml | kubectl apply -f -

            # 5. CoreDNS & Calico Restart (ì„¤ì • ë³€ê²½ ì‹œ ëŸ°íƒ€ì„ ë°˜ì˜ ë³´ì¥)
            # MTU ë³€ê²½ì´ íŒŒë“œì— ì¦‰ì‹œ ë°˜ì˜ë˜ì§€ ì•ŠëŠ” íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬ í•„ìš”í•œ ê²½ìš°ë§Œ ì¬ì‹œì‘ ìœ ë„
            if [[ $(kubectl get pods -n kube-system -l k8s-app=kube-dns -o jsonpath='{.items[0].status.phase}') != "Running" ]]; then
              kubectl delete pod -n kube-system -l k8s-app=kube-dns || true
            fi

            echo "â³ Waiting for ArgoCD Server Readiness..."
            kubectl rollout status deployment/argocd-server -n argocd --timeout=300s

            # 6. Root Application: ì„ ì–¸ì  ë“±ë¡
            echo "ğŸ“‚ Syncing Root Application..."
            REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/master/argocd/root-app.yaml"
            curl -s $REPO_URL | kubectl apply -f -

            echo "âœ… Declarative Setup Complete!"