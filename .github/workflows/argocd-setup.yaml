name: "Step 2: ArgoCD Base Setup"
on:
  workflow_dispatch:

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“– Read root-app.yaml
        id: read_root_app
        run: |
          # íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ í™˜ê²½ ë³€ìˆ˜ì— ì•ˆì „í•˜ê²Œ ì €ì¥ (ë©€í‹°ë¼ì¸ ëŒ€ì‘)
          echo "ROOT_APP_CONTENT<<EOF" >> $GITHUB_ENV
          cat root-app.yaml
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ—ï¸ Install ArgoCD & Apply Root App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          envs: ROOT_APP_CONTENT # ìœ„ì—ì„œ ì½ì€ íŒŒì¼ ë‚´ìš©ì„ ì „ë‹¬
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Infrastructure Fix"
            sudo ufw disable || true
            kubectl patch cm -n kube-system calico-config --type merge -p '{"data": {"veth_mtu": "1220"}}' || true

            echo "ğŸš€ Installing ArgoCD Core"
            kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
            kubectl apply --server-side --force-conflicts -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.10.4/manifests/install.yaml
            
            echo "â³ Waiting for ArgoCD Server"
            kubectl rollout status deployment/argocd-server -n argocd --timeout=300s

            echo "ğŸ“‚ Applying Root Application from file"
            # Runnerì—ì„œ ì½ì–´ì˜¨ íŒŒì¼ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì ìš©
            echo "$ROOT_APP_CONTENT" | kubectl apply -f -
            
            echo "âœ… ArgoCD & Root App Ready!"