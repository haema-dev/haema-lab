name: "Step 2: ArgoCD Bootstrapping"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/argocd-setup.yaml"

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ—ï¸ Install ArgoCD & Register Root App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            # 1. ArgoCD ì„¤ì¹˜ (ë©±ë“±ì„± ìœ ì§€ ë° ì„œë²„ ì¸¡ ë°˜ì˜)
            echo "ğŸš€ Installing ArgoCD..."
            kubectl create namespace argocd || true
            kubectl apply --server-side --force-conflicts -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

            # 2. íŒŒë“œê°€ ì‹¤ì œë¡œ APIì— ë³´ì¼ ë•Œê¹Œì§€ ëŒ€ê¸° (ì¤‘ìš”)
            echo "â³ Waiting for ArgoCD pods to appear..."
            # ìµœëŒ€ 2ë¶„ ë™ì•ˆ 5ì´ˆë§ˆë‹¤ íŒŒë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            for i in {1..24}; do
              if kubectl get pods -n argocd -l app.kubernetes.io/part-of=argocd 2>/dev/null | grep -q "."; then
                echo "âœ… Pods detected! Proceeding to wait for Ready state..."
                break
              fi
              if [ $i -eq 24 ]; then
                echo "âŒ Timeout waiting for pods to appear"
                exit 1
              fi
              echo "Still waiting for pods to be created ($i/24)..."
              sleep 5
            done
            
            # 3. íŒŒë“œê°€ Ready ìƒíƒœê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ Waiting for ArgoCD components to be Ready..."
            kubectl wait --for=condition=Ready pod -l app.kubernetes.io/part-of=argocd -n argocd --timeout=300s

            # 4. Grafana Secret ì£¼ì…
            echo "ğŸ” Injecting Grafana Credentials..."
            kubectl create namespace monitoring || true
            kubectl create secret generic grafana-admin-credentials \
              --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              -n monitoring \
              --dry-run=client -o yaml | kubectl apply -f -

            # 5. Root Application ë“±ë¡
            echo "ğŸ“‚ Applying Root Application..."
            REPO_OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            
            curl -s https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/master/argocd/root-app.yaml | kubectl apply -f -

            echo "âœ… ArgoCD Setup & Root App Registration Complete!"