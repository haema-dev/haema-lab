name: "Step 2: ArgoCD Bootstrapping"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/argocd-setup.yaml"

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ—ï¸ Install ArgoCD & Register Root App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ§¹ Phase 1: Total Destruction (Idempotency)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # 1. Root Application ë¨¼ì € ì œê±° (ì—°ì‡„ ì‚­ì œ ë°©ì§€ ë° ì•ˆì „í•œ ì¢…ë£Œ)
            kubectl delete application root-app -n argocd --timeout=30s || true

            # 2. ê´€ë ¨ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë° ë¦¬ì†ŒìŠ¤ ì¼ê´„ ì‚­ì œ
            # local-path-provisionerê¹Œì§€ í¬í•¨í•˜ì—¬ ì™„ì „íˆ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
            kubectl delete ns argocd monitoring --timeout=60s || true
            kubectl delete -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml || true
            
            # 3. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì™„ì „íˆ ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€ ëŒ€ê¸° (ê°€ì¥ ì¤‘ìš”)
            # 'Terminating' ìƒíƒœì—ì„œ ì¬ìƒì„±ì„ ì‹œë„í•˜ë©´ ì—ëŸ¬ê°€ ë‚˜ê¸° ë•Œë¬¸ì— í™•ì‹¤íˆ ê¸°ë‹¤ë ¤ì•¼ í•©ë‹ˆë‹¤.
            echo "â³ Waiting for cleanup to complete..."
            while kubectl get ns argocd 2>/dev/null || kubectl get ns monitoring 2>/dev/null; do
              echo "Still cleaning up residues..."
              sleep 5
            done
            echo "âœ… Cleanup complete. Proceeding to Fresh Install."

            echo ""
            echo "ğŸš€ Phase 2: Fresh Install & Configuration"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            # 0. StorageClass ì„¤ì¹˜ (ê¸°ì´ˆ ê³µì‚¬)
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

            # 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
            kubectl create namespace argocd
            kubectl create namespace monitoring

            # 2. ArgoCD ì„¤ì¹˜
            kubectl apply --server-side --force-conflicts -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.10.4/manifests/install.yaml

            # 3. Secrets ìƒì„± (ë©±ë“±ì„± ë³´ì¥í˜•: ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒì„±)
            # Redis Secret
            kubectl create secret generic argocd-redis \
              -n argocd --from-literal=auth='' \
              --dry-run=client -o yaml | kubectl apply -f -

            # Grafana Secret
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring \
              --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 4. ArgoCD ì„œë²„ ëŒ€ê¸°
            echo "â³ Waiting for ArgoCD Server Rollout..."
            kubectl rollout status deployment/argocd-server -n argocd --timeout=600s

            # 5. Root Application ë“±ë¡
            echo "ğŸ“‚ Applying Root Application..."
            REPO_OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            # master ë¸Œëœì¹˜ ê¸°ì¤€ìœ¼ë¡œ root-app.yamlì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            curl -s https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/master/argocd/root-app.yaml | kubectl apply -f -

            echo "âœ… All Setup Complete!"