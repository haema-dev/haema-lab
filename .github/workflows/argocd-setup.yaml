name: "Step 2: ArgoCD Bootstrapping"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/argocd-setup.yaml"

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ—ï¸ Install ArgoCD & Register Root App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ§¹ Phase 1: Deep Clean"
            # 1. ê¸°ì¡´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œ ì‹œë„
            kubectl delete ns argocd --timeout=60s || true
            
            # 2. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ê°€ ì™„ì „íˆ ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€ ëŒ€ê¸° (ë§¤ìš° ì¤‘ìš”)
            echo "â³ Waiting for old namespace to be completely gone..."
            while kubectl get ns argocd &>/dev/null; do
              echo "Namespace still terminating..."
              sleep 5
            done

            echo "ğŸš€ Phase 2: Fresh Install"
            # 3. ê¹¨ë—í•œ ìƒíƒœì—ì„œ ë‹¤ì‹œ ìƒì„±
            kubectl create namespace argocd
            
            # 4. ArgoCD ì„¤ì¹˜ (ë²„ì „ ê³ ì •ìœ¼ë¡œ ì•ˆì •ì„± í™•ë³´)
            kubectl apply --server-side --force-conflicts -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.10.4/manifests/install.yaml

            # 5. í•µì‹¬ ì‹œí¬ë¦¿(Redis Password)ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ ì¦‰ì‹œ í™•ì¸
            echo "ğŸ” Verifying critical secrets..."
            for i in {1..10}; do
              if kubectl get secret argocd-redis -n argocd &>/dev/null; then
                echo "âœ… argocd-redis secret found!"
                break
              fi
              echo "Waiting for secrets to be generated ($i/10)..."
              sleep 5
            done

            # 6. ì„œë²„ ë¡¤ì•„ì›ƒ ëŒ€ê¸°
            echo "â³ Waiting for ArgoCD Server Rollout..."
            kubectl rollout status deployment/argocd-server -n argocd --timeout=300s

            echo "âœ… ArgoCD Re-install Complete!"