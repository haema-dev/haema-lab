name: "Step 2: ArgoCD Bootstrapping"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/argocd-setup.yaml"

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
        #   oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        #   oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          version: 1.94.1 # 2026ë…„ ìµœì‹  ë²„ì „ ìœ ì§€
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
        #   tags: ${{ secrets.TAILSCALE_AUTH_TAGS }}

      - name: ğŸ—ï¸ Install ArgoCD & Register Root App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }} # VM 2(K8s)ì˜ IP
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY_GITHUB }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            # 1. ArgoCD ì„¤ì¹˜
            kubectl create namespace argocd || true
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

            # 2. ArgoCD ëŒ€ê¸° (Ready ìƒíƒœ í™•ì¸)
            echo "â³ Waiting for ArgoCD components..."
            kubectl wait --for=condition=Ready pod -l app.kubernetes.io/part-of=argocd -n argocd --timeout=300s

            # 3. Grafana Secret ì£¼ì… (Monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
            kubectl create namespace monitoring || true
            kubectl create secret generic grafana-admin-credentials \
              --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              -n monitoring \
              --dry-run=client -o yaml | kubectl apply -f -

            # 4. Root Application ë“±ë¡ (ì„¤ê³„í•˜ì‹  argocd/ í´ë” ì°¸ì¡°)
            echo "ğŸ“‚ Applying Root Application..."
            # curl ëŒ€ì‹  ë¡œì»¬ì— ì²´í¬ì•„ì›ƒëœ íŒŒì¼ì„ ì§ì ‘ ë³µì‚¬í•˜ê±°ë‚˜ GitHub ì£¼ì†Œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜µë‹ˆë‹¤.
            curl -s https://raw.githubusercontent.com/${{ github.repository }}/master/argocd/root-app.yaml | kubectl apply -f -

            echo "âœ… ArgoCD Setup & Root App Registration Complete!"