name: "Step 2: ArgoCD Bootstrapping"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/argocd-setup.yaml"

jobs:
  setup-argocd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ—ï¸ Install ArgoCD & Register Root App
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ§¹ Phase 1: Deep Clean"
            kubectl delete ns argocd --timeout=60s || true
            while kubectl get ns argocd &>/dev/null; do sleep 5; done

            echo "ğŸš€ Phase 2: Fresh Install"
            # 0. StorageClass ì„¤ì¹˜ (ê¸°ì´ˆ ê³µì‚¬)
            # ì´ê²Œ ì—†ìœ¼ë©´ í”„ë¡œë©”í…Œìš°ìŠ¤ì˜ PVC(10Gi)ë¥¼ í• ë‹¹í•  ìˆ˜ ì—†ì–´ ë°°í¬ê°€ ì‹¤íŒ¨í•©ë‹ˆë‹¤.
            echo "ğŸ“¦ Installing Local Path Provisioner..."
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            
            # ì„¤ì¹˜ëœ local-pathë¥¼ ê¸°ë³¸ ì €ì¥ì†Œ(Default)ë¡œ ì§€ì •
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

            # 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
            kubectl create namespace argocd || true
            
            # 2. ArgoCD ì„¤ì¹˜ (ë²„ì „ ê³ ì •)
            kubectl apply --server-side --force-conflicts -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.10.4/manifests/install.yaml

            # 3. ğŸš¨ [í•µì‹¬] ëˆ„ë½ ë°©ì§€ë¥¼ ìœ„í•œ Redis Secret ê°•ì œ ìƒì„±
            echo "ğŸ” Injecting ArgoCD Redis Secret..."
            kubectl create secret generic argocd-redis \
              -n argocd --from-literal=auth='' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 4. ğŸ” [í•µì‹¬] Prometheusìš© Grafana Secret ì£¼ì…
            echo "ğŸ” Injecting Grafana Credentials for Prometheus..."
            kubectl create namespace monitoring || true
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring \
              --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 5. ArgoCD ì„œë²„ ëŒ€ê¸° (íƒ€ì„ì•„ì›ƒ 10ë¶„ ì—°ì¥)
            echo "â³ Waiting for ArgoCD Server Rollout..."
            kubectl rollout status deployment/argocd-server -n argocd --timeout=600s

            # 6. ğŸ“‚ Root Application ë“±ë¡ (Prometheus í¬í•¨ ëª¨ë“  ì•±ì˜ ì‹œì‘ì )
            echo "ğŸ“‚ Applying Root Application..."
            REPO_OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
            REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
            curl -s https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/master/argocd/root-app.yaml | kubectl apply -f -

            echo "âœ… All Setup Complete!"