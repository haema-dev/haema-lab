name: Kubespray K8s

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          # oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          # oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          # tags: ${{ secrets.TAILSCALE_AUTH_TAGS }}


      - name: Setup K8s with Kubespray
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            KUBE_VERSION="1.31.6"
            echo $KUBE_VERSION
            #!/bin/bash
            set -e

            echo "ðŸ” Complete cleanup"
            echo "1ï¸âƒ£ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ ë° í¬íŠ¸ í•´ì œ"
            pkill -9 kube-apiserver 2>/dev/null || true
            pkill -9 kube-controller-manager 2>/dev/null || true
            pkill -9 kube-scheduler 2>/dev/null || true
            pkill -9 kubelet 2>/dev/null || true
            pkill -9 etcd 2>/dev/null || true
            sleep 2
            fuser -k 6443/tcp 2>/dev/null || true
            fuser -k 10259/tcp 2>/dev/null || true
            fuser -k 10257/tcp 2>/dev/null || true
            fuser -k 10250/tcp 2>/dev/null || true
            fuser -k 2379/tcp 2>/dev/null || true
            fuser -k 2380/tcp 2>/dev/null || true
            
            echo "2ï¸âƒ£ kubeadm í™•ì¸"
            if [ -f /etc/kubernetes/manifests/kube-apiserver.yaml ]; then
              echo "âœ… Kubernetes already initialized"
              exit 0
            fi
            
            echo "3ï¸âƒ£ etcd ì •ë¦¬"
            systemctl stop etcd 2>/dev/null || true
            systemctl disable etcd 2>/dev/null || true
            rm -rf /var/lib/etcd /etc/etcd /etc/ssl/etcd /opt/etcd* 2>/dev/null || true
            
            echo "4ï¸âƒ£ kubelet ë° container ì •ë¦¬"
            systemctl stop kubelet 2>/dev/null || true
            systemctl stop kube-* 2>/dev/null || true
            rm -rf /var/lib/kubelet /etc/kubernetes /etc/cni /opt/cni 2>/dev/null || true
            rm -rf /var/run/kubernetes 2>/dev/null || true
            crictl rm -a 2>/dev/null || true
            crictl rmi --prune 2>/dev/null || true
            ctr image rm -f 2>/dev/null || true
            
            # ðŸ” 5ì´ˆ ëŒ€ê¸°
            sleep 5
            
            echo "5ï¸âƒ£ K8s Setup with Kubespray"            
            apt-get update -qq
            apt-get install -y -qq python3-pip python3-venv git
            
            # ðŸ” Create virtual env
            python3 -m venv ~/.venv-kubespray
            source ~/.venv-kubespray/bin/activate
            
            echo "6ï¸âƒ£ Kubespray Download"
            cd /tmp
            rm -rf kubespray || true
            git clone https://github.com/kubernetes-sigs/kubespray.git
            cd kubespray
            # ðŸ” ubuntu 24.04 bugfix version
            git checkout v2.29.0
            
            echo "7ï¸âƒ£ Install requirements vis Kubespray in virtual env"
            pip install -r requirements.txt
            
            cp -rfp inventory/sample inventory/mycluster
            mkdir -p inventory/mycluster/group_vars/all
            
            echo "8ï¸âƒ£ Before k8s cluster"
            tee inventory/mycluster/hosts.yaml > /dev/null <<'HOSTS'
            all:
              hosts:
                ${{ secrets.USERNAME }}:
                  ansible_connection: local
                  ansible_host: 127.0.0.1
                  ip: ${{ secrets.HOST_IP }}
                  access_ip: ${{ secrets.HOST_IP }}
              children:
                kube_control_plane:
                  hosts:
                    ${{ secrets.USERNAME }}:
                kube_node:
                  hosts:
                    ${{ secrets.USERNAME }}:
                etcd:
                  hosts:
                    ${{ secrets.USERNAME }}:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            HOSTS
            
            echo "9ï¸âƒ£ group_vars/all/all.yml"
            tee inventory/mycluster/group_vars/all/all.yml > /dev/null <<'VARS'
            kube_version: $KUBE_VERSION
            container_manager: containerd
            dns_mode: coredns
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            kube_apiserver_advertise_address: ${{ secrets.HOST_IP }}
            kube_apiserver_bind_address: 0.0.0.0
            kubeadm_init_timeout: 600
            VARS
            
            echo "ðŸ”Ÿ ansible-playbook ì‹¤í–‰"
            ansible-playbook -i inventory/mycluster/hosts.yaml \
            --become \
            cluster.yml
            echo "ðŸŽ‰ K8s Setup Complete"
            
            # ðŸ” Before fix
            sudo usermod -s /bin/bash $(whoami)
            echo "âœ… Shell Fixed"

            # ðŸ” Setting up kubeconfig
            sudo mkdir -p /home/${{ secrets.USERNAME }}/.kube
            sudo cp /etc/kubernetes/admin.conf /home/${{ secrets.USERNAME }}/.kube/config
            sudo chown -R ${{ secrets.USERNAME }}:${{ secrets.USERNAME }} /home/${{ secrets.USERNAME }}/.kube
            sudo chmod 600 /home/${{ secrets.USERNAME }}/.kube/config

            # ðŸ” Check
            sudo ls -la /home/${{ secrets.USERNAME }}/.kube/config
            echo "âœ… K8s setup complete"