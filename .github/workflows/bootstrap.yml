name: Bootstrap K8s & ArgoCD

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/*.yml'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
      
      - name: Install K8s (kubeadm)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Installing Kubernetes v1.29 ==="
            
            sudo apt-get update
            sudo apt-get install -y ca-certificates curl gpg
            
            # 최신 공식 K8s 리포지토리
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
            
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y kubelet kubeadm kubectl containerd
            sudo apt-mark hold kubelet kubeadm kubectl
            
            # containerd 설정
            sudo mkdir -p /etc/containerd
            sudo containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
            sudo systemctl restart containerd
            sudo systemctl enable containerd
            
            # 커널 설정
            sudo modprobe br_netfilter overlay
            sudo tee /etc/sysctl.d/99-kubernetes.conf > /dev/null <<EOF
            net.bridge.bridge-nf-call-iptables  = 1
            net.bridge.bridge-nf-call-ip6tables = 1
            net.ipv4.ip_forward                 = 1
            EOF
            sudo sysctl --system
            
            # K8s 클러스터 초기화
            sudo kubeadm init --pod-network-cidr=10.244.0.0/16
            
            echo "=== K8s installation complete ==="
      
      - name: Install ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            export KUBECONFIG=/etc/kubernetes/admin.conf
            
            echo "=== Installing ArgoCD ==="
            
            kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
            
            echo "=== ArgoCD installation complete ==="
