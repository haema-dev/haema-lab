name: Kubespray K8s

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          version: 1.94.1
          tags: ${{ secrets.TAILSCALE_AUTH_TAGS }}


      - name: Setup K8s with Kubespray
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e

            kubeadm reset -f || true
            
            echo "=== K8s Setup with Kubespray ==="            
            sudo apt-get update
            sudo apt-get install -y python3-pip python3-venv git
            
            # Create virtual env
            python3 -m venv ~/.venv-kubespray
            source ~/.venv-kubespray/bin/activate
            
            cd /tmp
            rm -rf kubespray || true
            git clone https://github.com/kubernetes-sigs/kubespray.git
            cd kubespray
            
            # v2.28.1 LTS version
            git checkout v2.28.1
            
            # Install requirements vis Kubespray in virtual env
            pip install -r requirements.txt
            
            cp -rfp inventory/sample inventory/mycluster
            
            cat > inventory/mycluster/hosts.yaml <<'HOSTS_EOF'
            all:
              hosts:
                ${{ secrets.USERNAME }}:
                  ansible_connection: local
                  ansible_host: 127.0.0.1
                  ip: ${{ secrets.HOST_IP }}
                  access_ip: ${{ secrets.HOST_IP }}
              children:
                kube_control_plane:
                  hosts:
                    ${{ secrets.USERNAME }}:
                kube_node:
                  hosts:
                    ${{ secrets.USERNAME }}:
                etcd:
                  hosts:
                    ${{ secrets.USERNAME }}:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            HOSTS_EOF
            
            cat > inventory/mycluster/group_vars/all/all.yml <<'VARS_EOF'
            kube_version: "1.31.6"  # v2.28.1ì—ì„œ ì§€ì›í•˜ëŠ” LTS ë²„ì „
            container_manager: containerd
            dns_mode: coredns
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            kube_apiserver_advertise_address: "${{ secrets.HOST_IP }}"
            kube_apiserver_bind_address: "0.0.0.0"
            VARS_EOF
            
            echo "ðŸ” Before ansible-playbook"
            ansible-playbook -i inventory/mycluster/hosts.yaml \
              --become \
              cluster.yml
            
            echo "ðŸ” After ansible-playbook"
            
            kubectl get nodes || echo "kubectl failed"
            echo "ðŸŽ‰ K8s Setup Complete"
            
            echo "ðŸ” Before fix"
            sudo usermod -s /bin/bash $(whoami)
            echo "âœ… Shell Fixed"

            sudo su -

            # Set kubeconfig
            mkdir -p /home/${{ secrets.USERNAME }}/.kube
            cp /etc/kubernetes/admin.conf /home/${{ secrets.USERNAME }}/.kube/config
            chown -R ${{ secrets.USERNAME }}:${{ secrets.USERNAME }} /home/${{ secrets.USERNAME }}/.kube
            chmod 600 /home/${{ secrets.USERNAME }}/.kube/config

            # Check
            ls -la /home/${{ secrets.USERNAME }}/.kube/config
            echo "âœ… K8s setup complete"