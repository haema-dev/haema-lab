name: Bootstrap K8s & ArgoCD & Monitoring

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Setup K8s with Kubespray
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== K8s Setup with Kubespray ==="
            
            sudo apt-get update
            sudo apt-get install -y python3-pip python3-venv git
            
            # Í∞ÄÏÉÅÌôòÍ≤Ω ÏÉùÏÑ±
            python3 -m venv ~/.venv-kubespray
            source ~/.venv-kubespray/bin/activate
            
            cd /tmp
            rm -rf kubespray || true
            git clone https://github.com/kubernetes-sigs/kubespray.git
            cd kubespray
            
            # v2.28.1 LTS Î≤ÑÏ†Ñ
            git checkout v2.28.1
            
            # Í∞ÄÏÉÅÌôòÍ≤ΩÏóêÏÑú ÏÑ§Ïπò
            pip install -r requirements.txt
            
            cp -rfp inventory/sample inventory/mycluster
            
            cat > inventory/mycluster/hosts.yaml <<'EOF'
            all:
              hosts:
                node1:
                  ansible_connection: local
                  ansible_host: 127.0.0.1
                  ip: 127.0.0.1
                  access_ip: 127.0.0.1
              children:
                kube_control_plane:
                  hosts:
                    node1:
                kube_node:
                  hosts:
                    node1:
                etcd:
                  hosts:
                    node1:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            EOF
            
            cat > inventory/mycluster/group_vars/all/all.yml <<'EOF'
            kube_version: "1.31.6"  # v2.28.1ÏóêÏÑú ÏßÄÏõêÌïòÎäî LTS Î≤ÑÏ†Ñ
            container_manager: containerd
            dns_mode: coredns
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            EOF
            
            ansible-playbook -i inventory/mycluster/hosts.yaml \
              --become --become-user=root \
              cluster.yml
            
            mkdir -p $HOME/.kube
            sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
            sudo chown $(id -u):$(id -g) $HOME/.kube/config
            export KUBECONFIG=$HOME/.kube/config
            
            echo "‚è≥ Waiting for K8s..."
            for i in {1..120}; do
              if kubectl cluster-info &> /dev/null; then
                echo "‚úÖ K8s Ready"
                break
              fi
              sleep 3
            done
            
            kubectl get nodes
            
            echo "üéâ K8s Setup Complete"

            # KubesprayÍ∞Ä nologinÏúºÎ°ú ÏÑ§Ï†ïÌïú Í≤É Î≥µÍµ¨
            # sudo usermod -s /bin/bash ${{ secrets.USERNAME }}


      # - name: Fix Shell Access
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
      #     username: ${{ secrets.USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       #!/bin/bash
      #       set -e
            
      #       sudo usermod -s /bin/bash kube
      #       echo "‚úÖ Shell Access Restored"


      # - name: Install ArgoCD
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
      #     username: ${{ secrets.USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       #!/bin/bash
      #       set -e
            
      #       echo "=== ArgoCD Installation ==="
            
      #       export KUBECONFIG=$HOME/.kube/config
            
      #       kubectl create namespace argocd || true
      #       kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
            
      #       echo "‚è≥ Waiting for ArgoCD..."
      #       kubectl wait --for=condition=Ready pod -l app.kubernetes.io/part-of=argocd -n argocd --timeout=300s || true
            
      #       echo "=== ArgoCD Status ==="
      #       kubectl get pods -n argocd
            
      #       echo ""
      #       echo "üîê === ArgoCD Initial Password ==="
      #       kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      #       echo ""
            
      #       echo "üéâ === ArgoCD Installation Complete ==="

      # - name: Install Prometheus & Grafana
      #   uses: appleboy/ssh-action@master
      #   env:
      #     GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
      #   with:
      #     host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
      #     username: ${{ secrets.USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       #!/bin/bash
      #       set -e
            
      #       echo "=== Prometheus & Grafana Installation ==="
            
      #       export KUBECONFIG=$HOME/.kube/config
            
      #       # 1. Prometheus ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§
      #       kubectl create namespace prometheus || true
            
      #       # 2. Helm ÏÑ§Ïπò (ÏóÜÏúºÎ©¥)
      #       if ! command -v helm &> /dev/null; then
      #         curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      #       fi
            
      #       # 3. Prometheus ÏÑ§Ïπò (Helm)
      #       helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      #       helm repo update
            
      #       helm install prometheus prometheus-community/prometheus \
      #         -n prometheus \
      #         --set prometheus.prometheusSpec.retention=15d \
      #         --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi \
      #         || echo "Prometheus already installed"
            
      #       # 4. Grafana ÏÑ§Ïπò (Helm)
      #       helm repo add grafana https://grafana.github.io/helm-charts
      #       helm repo update
            
      #       kubectl create namespace grafana || true
            
      #       helm install grafana grafana/grafana \
      #         -n grafana \
      #         --set adminPassword=$GRAFANA_PASSWORD \
      #         --set persistence.enabled=true \
      #         --set persistence.size=5Gi \
      #         || echo "Grafana already installed"
            
      #       echo "‚è≥ Waiting for Prometheus & Grafana..."
      #       kubectl wait --for=condition=Ready pod -n prometheus --all --timeout=300s || true
      #       kubectl wait --for=condition=Ready pod -n grafana --all --timeout=300s || true
            
      #       echo "=== Services Status ==="
      #       echo ""
      #       echo "Prometheus:"
      #       kubectl get svc -n prometheus
      #       echo ""
      #       echo "Grafana:"
      #       kubectl get svc -n grafana
            
      #       echo ""
      #       echo "üìä === Grafana Access ==="
      #       echo "Service: kubectl port-forward svc/grafana -n grafana 3000:80"
      #       echo ""
            
      #       echo "üìà === Prometheus Access ==="
      #       echo "Service: kubectl port-forward svc/prometheus-server -n prometheus 9090:80"
      #       echo ""
            
      #       echo "üéâ === Monitoring Setup Complete ==="