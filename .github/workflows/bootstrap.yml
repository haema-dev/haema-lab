name: Kubespray K8s

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'

jobs:
  setup:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          # oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          # oauth-secret: ${{ secrets.TAILSCALE_OAUTH_CLIENT_SECRET }}
          # tags: ${{ secrets.TAILSCALE_AUTH_TAGS }}


      - name: Setup K8s with Kubespray
        uses: appleboy/ssh-action@master
        env:
          KUBE_VERSION: "1.31.6"
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e

            echo "ðŸ” Complete cleanup"

            # í¬íŠ¸ í•´ì œ
            sudo fuser -k 6443/tcp 2>/dev/null || true
            sudo fuser -k 10259/tcp 2>/dev/null || true
            sudo fuser -k 10257/tcp 2>/dev/null || true
            
            # kubeadmì´ ì´ë¯¸ ì‹¤í–‰ëëŠ”ì§€ í™•ì¸
            if [ -f /etc/kubernetes/manifests/kube-apiserver.yaml ]; then
              echo "âœ… Kubernetes already initialized, skipping..."
              exit 0
            fi
            
            echo "ðŸ”„ Initializing cluster..."
            # etcd ì™„ì „ ì •ì§€
            sudo systemctl stop etcd || true
            sudo systemctl disable etcd || true
            
            # etcd ëª¨ë“  ë°ì´í„° & ì„¤ì • ì‚­ì œ
            sudo rm -rf /var/lib/etcd
            sudo rm -rf /etc/etcd
            sudo rm -rf /etc/ssl/etcd
            sudo rm -rf /opt/etcd*
            
            # kubelet ì •ë¦¬
            sudo systemctl stop kubelet || true
            sudo rm -rf /var/lib/kubelet /etc/kubernetes
            
            # 5ì´ˆ ëŒ€ê¸°
            sleep 5
            
            echo "ðŸ” Ready for Kubespray"
            cd /tmp/kubespray
            ansible-playbook -i inventory/mycluster/hosts.yaml \
              --become \
              cluster.yml
            
            echo "ðŸ” K8s Setup with Kubespray"            
            sudo apt-get update
            sudo apt-get install -y python3-pip python3-venv git
            
            # Create virtual env
            python3 -m venv ~/.venv-kubespray
            source ~/.venv-kubespray/bin/activate
            
            cd /tmp
            rm -rf kubespray || true
            git clone https://github.com/kubernetes-sigs/kubespray.git
            cd kubespray
            
            # ubuntu 24.04 bugfix version
            git checkout v2.29.0
            
            # Install requirements vis Kubespray in virtual env
            pip install -r requirements.txt
            
            cp -rfp inventory/sample inventory/mycluster
            
            echo "ðŸ” Before k8s cluster"
            cat > inventory/mycluster/hosts.yaml <<'HOSTS_EOF'
            all:
              hosts:
                ${{ secrets.USERNAME }}:
                  ansible_connection: local
                  ansible_host: 127.0.0.1
                  ip: ${{ secrets.HOST_IP }}
                  access_ip: ${{ secrets.HOST_IP }}
              children:
                kube_control_plane:
                  hosts:
                    ${{ secrets.USERNAME }}:
                kube_node:
                  hosts:
                    ${{ secrets.USERNAME }}:
                etcd:
                  hosts:
                    ${{ secrets.USERNAME }}:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            HOSTS_EOF
            
            cat > inventory/mycluster/group_vars/all/all.yml <<'VARS_EOF'
            kube_version: $KUBE_VERSION
            container_manager: containerd
            dns_mode: coredns
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            kube_apiserver_advertise_address: "${{ secrets.HOST_IP }}"
            kube_apiserver_bind_address: "0.0.0.0"
            VARS_EOF
            
            echo "ðŸ” Before ansible-playbook"
            ansible-playbook -i inventory/mycluster/hosts.yaml \
            --become \
            -e "kube_version=$KUBE_VERSION \
            -e "ansible_timeout=300" \
            -e "ansible_connection_timeout=60" \
            cluster.yml
            kubectl get nodes || echo "kubectl failed"
            echo "ðŸŽ‰ K8s Setup Complete"
            
            echo "ðŸ” Before fix"
            sudo usermod -s /bin/bash $(whoami)
            echo "âœ… Shell Fixed"

            echo "ðŸ” Setting up kubeconfig"
            sudo mkdir -p /home/${{ secrets.USERNAME }}/.kube
            sudo cp /etc/kubernetes/admin.conf /home/${{ secrets.USERNAME }}/.kube/config
            sudo chown -R ${{ secrets.USERNAME }}:${{ secrets.USERNAME }} /home/${{ secrets.USERNAME }}/.kube
            sudo chmod 600 /home/${{ secrets.USERNAME }}/.kube/config

            # Check
            sudo ls -la /home/${{ secrets.USERNAME }}/.kube/config
            echo "âœ… K8s setup complete"