name: Bootstrap K8s & ArgoCD

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/*.yml'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
      
      - name: Install K8s (kubeadm)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Installing Kubernetes v1.29 ==="
            
            # 이미 설치되어 있으면 스킵
            if command -v kubeadm &> /dev/null && sudo kubeadm version &> /dev/null; then
              echo "Kubernetes already installed, skipping installation"
              exit 0
            fi
            
            sudo apt-get update
            sudo apt-get install -y ca-certificates curl
            
            # GPG 키 다운로드
            sudo mkdir -p /etc/apt/keyrings
            sudo sh -c 'curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key > /tmp/k8s.key && cat /tmp/k8s.key | gpg --dearmor > /etc/apt/keyrings/kubernetes-apt-keyring.gpg'
            
            echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list > /dev/null
            
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y kubelet kubeadm kubectl containerd
            sudo apt-mark hold kubelet kubeadm kubectl
            
            # containerd 설정
            sudo mkdir -p /etc/containerd
            sudo containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
            sudo systemctl restart containerd
            sudo systemctl enable containerd
            
            # 커널 설정
            sudo modprobe br_netfilter overlay
            sudo tee /etc/sysctl.d/99-kubernetes.conf > /dev/null <<EOF
            net.bridge.bridge-nf-call-iptables  = 1
            net.bridge.bridge-nf-call-ip6tables = 1
            net.ipv4.ip_forward                 = 1
            EOF
            sudo sysctl --system
            
            # K8s 클러스터 초기화
            sudo kubeadm init --pod-network-cidr=10.244.0.0/16
            
            echo "=== K8s installation complete ==="
      
      - name: Install ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Installing ArgoCD ==="
            
            export KUBECONFIG=/etc/kubernetes/admin.conf
            sudo chmod 644 /etc/kubernetes/admin.conf
            
            # ArgoCD 네임스페이스가 이미 존재하는지 확인
            if kubectl get namespace argocd &> /dev/null; then
              echo "ArgoCD already installed, skipping installation"
              exit 0
            fi
            
            # ArgoCD 네임스페이스 생성
            kubectl create namespace argocd
            
            # ArgoCD 설치
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
            
            # 설치 완료 대기
            sleep 10
            
            # ArgoCD 상태 확인
            kubectl get pods -n argocd
            
            echo "=== ArgoCD installation complete ==="
