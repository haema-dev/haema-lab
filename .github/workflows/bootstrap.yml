name: Bootstrap K8s & ArgoCD & Monitoring

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
      - name: Setup K8s with Kubespray
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== K8s Setup with Kubespray ==="
            
            sudo apt-get update
            sudo apt-get install -y ansible-core git
            
            cd /tmp
            rm -rf kubespray || true
            git clone https://github.com/kubernetes-sigs/kubespray.git
            cd kubespray
            
            cp -rfp inventory/sample inventory/mycluster
            
            cat > inventory/mycluster/hosts.yaml <<'EOF'
            all:
              hosts:
                node1:
                  ansible_connection: local
                  ansible_host: 127.0.0.1
                  ip: 127.0.0.1
                  access_ip: 127.0.0.1
              children:
                kube_control_plane:
                  hosts:
                    node1:
                kube_node:
                  hosts:
                    node1:
                etcd:
                  hosts:
                    node1:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            EOF
            
            mkdir -p inventory/mycluster/group_vars/all
            cat > inventory/mycluster/group_vars/all/all.yml <<'EOF'
            kube_version: v1.29.8
            container_manager: containerd
            dns_mode: coredns
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            EOF
            
            ansible-playbook -i inventory/mycluster/hosts.yaml \
              --become --become-user=root \
              cluster.yml
            
            mkdir -p $HOME/.kube
            sudo cp /etc/kubernetes/admin.conf $HOME/.kube/config
            sudo chown $(id -u):$(id -g) $HOME/.kube/config
            export KUBECONFIG=$HOME/.kube/config
            
            echo "‚è≥ Waiting for K8s..."
            for i in {1..120}; do
              if kubectl cluster-info &> /dev/null; then
                echo "‚úÖ K8s Ready"
                break
              fi
              sleep 3
            done
            
            kubectl get nodes
            
            echo "üéâ K8s Setup Complete"
      

      - name: Install ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== ArgoCD Installation ==="
            
            export KUBECONFIG=$HOME/.kube/config
            
            kubectl create namespace argocd || true
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
            
            echo "‚è≥ Waiting for ArgoCD..."
            kubectl wait --for=condition=Ready pod -l app.kubernetes.io/part-of=argocd -n argocd --timeout=300s || true
            
            echo "=== ArgoCD Status ==="
            kubectl get pods -n argocd
            
            echo ""
            echo "üîê === ArgoCD Initial Password ==="
            kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
            echo ""
            
            echo "üéâ === ArgoCD Installation Complete ==="
      
            
      - name: Install Prometheus & Grafana
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Prometheus & Grafana Installation ==="
            
            export KUBECONFIG=$HOME/.kube/config
            
            # 1. Prometheus ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§
            kubectl create namespace prometheus || true
            
            # 2. Prometheus ÏÑ§Ïπò (Helm)
            curl -fsSL https://raw.githubusercontent.com/prometheus-community/helm-charts/main/prometheus/values.yaml -o /tmp/prometheus-values.yaml
            
            # Helm ÏÑ§Ïπò (ÏóÜÏúºÎ©¥)
            if ! command -v helm &> /dev/null; then
              curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            fi
            
            # Prometheus Helm Chart Ï∂îÍ∞Ä
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
            helm repo update
            
            # Prometheus ÏÑ§Ïπò
            helm install prometheus prometheus-community/prometheus \
              -n prometheus \
              --set prometheus.prometheusSpec.retention=15d \
              --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=10Gi
            
            # 3. Grafana ÏÑ§Ïπò (Helm)
            helm repo add grafana https://grafana.github.io/helm-charts
            helm repo update
            
            kubectl create namespace grafana || true
            
            helm install grafana grafana/grafana \
              -n grafana \
              --set adminPassword=admin123 \
              --set persistence.enabled=true \
              --set persistence.size=5Gi
            
            echo "‚è≥ Waiting for Prometheus & Grafana..."
            kubectl wait --for=condition=Ready pod -n prometheus --all --timeout=300s || true
            kubectl wait --for=condition=Ready pod -n grafana --all --timeout=300s || true
            
            echo "=== Services Status ==="
            echo ""
            echo "Prometheus:"
            kubectl get svc -n prometheus
            echo ""
            echo "Grafana:"
            kubectl get svc -n grafana
            
            echo ""
            echo "üìä === Grafana Credentials ==="
            echo "Username: admin"
            echo "Password: admin123"
            echo "Service: kubectl port-forward svc/grafana -n grafana 3000:80"
            echo ""
            
            echo "üìà === Prometheus Access ==="
            echo "Service: kubectl port-forward svc/prometheus-server -n prometheus 9090:80"
            echo ""
            
            echo "üéâ === Monitoring Setup Complete ==="
