name: Kubespray K8s - Idempotent

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'
      - 'k8s-config/**'

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Setup K8s with Kubespray (Idempotent)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop_on_error: true
          script: |
            set -e

            # í¬íŠ¸ ì ìœ  í™•ì¸
            echo "ğŸ” Checking port occupation..."
            OCCUPIED_PORTS=""
            for port in 6443 2379 10250; do
              if sudo lsof -Pi ":$port" -sTCP:LISTEN -t >/dev/null 2>&1; then
                OCCUPIED_PORTS="$OCCUPIED_PORTS $port"
              fi
            done
            
            if [ ! -z "$OCCUPIED_PORTS" ]; then
              echo "âš ï¸ Ports occupied:$OCCUPIED_PORTS"
              echo "ğŸ§¹ Force cleaning..."
              sudo systemctl stop kubelet etcd 2>/dev/null || true
              for port in $OCCUPIED_PORTS; do
                sudo fuser -k "$port/tcp" 2>/dev/null || true
              done
              sleep 3
            else
              echo "âœ… All ports free"
            fi

            set -euo pipefail
            
            KUBE_VERSION="1.31.6"
            KUBESPRAY_VERSION="v2.29.0"
            KUBESPRAY_HOME="/opt/kubespray"
            VENV_PATH="/opt/venv-kubespray"
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ”„ Kubespray Idempotent Setup"
            echo "Kubernetes: $KUBE_VERSION"
            echo "Kubespray: $KUBESPRAY_VERSION"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # ============================================
            # 1ï¸âƒ£ ìƒíƒœ ì²´í¬: ì´ë¯¸ ì™„ì„±ëœ í´ëŸ¬ìŠ¤í„°ì¸ê°€?
            # ============================================
            check_cluster_health() {
              if ! command -v kubectl &> /dev/null; then
                return 1
              fi
              
              if ! kubectl cluster-info &>/dev/null; then
                return 1
              fi
              
              # ëª¨ë“  ë…¸ë“œê°€ Ready ìƒíƒœì¸ê°€?
              READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c " Ready " || echo 0)
              TOTAL_NODES=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo 0)
              
              if [ "$READY_NODES" -eq "$TOTAL_NODES" ] && [ "$TOTAL_NODES" -gt 0 ]; then
                return 0
              fi
              return 1
            }
            
            if check_cluster_health; then
              echo "âœ… Kubernetes cluster is healthy"
              echo "   $(kubectl version --short 2>/dev/null || echo 'kubectl available')"
              echo "   Nodes: $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)"
              exit 0
            fi
            
            echo "âš ï¸  Cluster health check failed or cluster not initialized"
            echo "   Proceeding with Kubespray..."
            
            # ============================================
            # 2ï¸âƒ£ í™˜ê²½ ì¤€ë¹„ (ë©±ë“±ì„±: ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
            # ============================================
            echo ""
            echo "ğŸ“¦ Installing dependencies..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq \
              python3-pip python3-venv git jq curl \
              2>&1 | grep -v "^Processing triggers\|^done\.$" || true
            
            # ============================================
            # 3ï¸âƒ£ Kubespray ì¤€ë¹„ (ë©±ë“±ì„± êµ¬í˜„)
            # ============================================
            echo ""
            echo "ğŸ“¥ Setting up Kubespray..."
            
            # ì´ë¯¸ ì¡´ì¬í•˜ê³  ì˜¬ë°”ë¥¸ ë²„ì „ì´ë©´ ìŠ¤í‚µ
            if [ -d "$KUBESPRAY_HOME/.git" ]; then
              CURRENT_VERSION=$(cd "$KUBESPRAY_HOME" && git describe --tags 2>/dev/null || echo "unknown")
              if [ "$CURRENT_VERSION" = "$KUBESPRAY_VERSION" ]; then
                echo "   âœ… Kubespray $KUBESPRAY_VERSION already cloned"
              else
                echo "   ğŸ”„ Updating Kubespray from $CURRENT_VERSION to $KUBESPRAY_VERSION"
                cd "$KUBESPRAY_HOME"
                git fetch origin
                git checkout "$KUBESPRAY_VERSION"
              fi
            else
              echo "   ğŸ“¥ Cloning Kubespray..."
              sudo rm -rf "$KUBESPRAY_HOME"
              sudo mkdir -p "$KUBESPRAY_HOME"
              git clone --depth 1 --branch "$KUBESPRAY_VERSION" \
                https://github.com/kubernetes-sigs/kubespray.git "$KUBESPRAY_HOME"
              sudo chown -R "$USER:$USER" "$KUBESPRAY_HOME"
            fi
            
            # ============================================
            # 4ï¸âƒ£ Python ê°€ìƒí™˜ê²½ (ë©±ë“±ì„±: ì´ë¯¸ ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
            # ============================================
            echo ""
            echo "ğŸ Setting up Python environment..."
            
            if [ ! -d "$VENV_PATH" ]; then
              python3 -m venv "$VENV_PATH"
              echo "   âœ… Created virtual environment"
            else
              echo "   âœ… Using existing virtual environment"
            fi
            
            source "$VENV_PATH/bin/activate"
            pip install -q --upgrade pip
            pip install -q -r "$KUBESPRAY_HOME/requirements.txt"
            
            # ============================================
            # 5ï¸âƒ£ Ansible ì¸ë²¤í† ë¦¬ ì„¤ì •
            # ============================================
            echo ""
            echo "ğŸ“‹ Configuring Ansible inventory..."
            
            INVENTORY_DIR="$KUBESPRAY_HOME/inventory/mycluster"
            
            # ì´ë¯¸ ìˆìœ¼ë©´ ë°±ì—…
            if [ -d "$INVENTORY_DIR" ]; then
              BACKUP_DIR="$KUBESPRAY_HOME/inventory/mycluster.backup.$(date +%s)"
              cp -r "$INVENTORY_DIR" "$BACKUP_DIR"
              echo "   âœ… Backed up existing inventory to $BACKUP_DIR"
            fi
            
            mkdir -p "$INVENTORY_DIR/group_vars/all"
            
            # hosts.yaml ìƒì„± (ë©±ë“±ì„±: ë‚´ìš©ì´ ê°™ìœ¼ë©´ ë®ì–´ì“°ê¸° OK)
            cat > "$INVENTORY_DIR/hosts.yaml" <<'HOSTS'
            all:
              hosts:
                ${{ secrets.USERNAME }}:
                  ansible_connection: local
                  ansible_host: 127.0.0.1
                  ip: "{{ ansible_host }}"
                  access_ip: "{{ ansible_host }}"
              children:
                kube_control_plane:
                  hosts:
                    ${{ secrets.USERNAME }}:
                kube_node:
                  hosts:
                    ${{ secrets.USERNAME }}:
                etcd:
                  hosts:
                    ${{ secrets.USERNAME }}:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            HOSTS
            
            # all.yml ìƒì„± (ë©±ë“±ì„±: ë³€ê²½ì‚¬í•­ë§Œ ì ìš©)
            cat > "$INVENTORY_DIR/group_vars/all/all.yml" <<'VARS'
            ---
            # Kubernetes
            kube_version: 1.31.6
            container_manager: containerd
            dns_mode: coredns
            
            # Network
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            kube_apiserver_advertise_address: "127.0.0.1"
            kube_apiserver_bind_address: "0.0.0.0"
            
            # Kubelet
            kubelet_deployment_type: host
            
            # Timeouts
            kubeadm_init_timeout: 600
            upgrade_cluster_setup_timeout: 600
            
            # Skip unnecessary checks for single-node
            skip_kubelet_systemd_environment_file_checks: true
            VARS
            
            echo "   âœ… Inventory configured"
            
            # ============================================
            # 6ï¸âƒ£ Kubespray ì‹¤í–‰ (ë©±ë“±ì„± í•µì‹¬)
            # ============================================
            echo ""
            echo "ğŸš€ Running Kubespray (idempotent)..."
            echo "   This may take 15-20 minutes..."
            
            cd "$KUBESPRAY_HOME"
            
            # KubesprayëŠ” ë©±ë“±ì„±ì„ ìœ„í•´ ì„¤ê³„ë¨
            # ì´ë¯¸ ì´ˆê¸°í™”ëœ ë¶€ë¶„ì€ ìŠ¤í‚µí•˜ê³  í•„ìš”í•œ ë¶€ë¶„ë§Œ ì—…ë°ì´íŠ¸
            ansible-playbook \
              -i "$INVENTORY_DIR/hosts.yaml" \
              --become \
              --become-method=sudo \
              -v \
              cluster.yml
            
            if [ $? -ne 0 ]; then
              echo "âŒ Kubespray failed"
              exit 1
            fi
            
            echo "âœ… Kubespray completed"
            
            # ============================================
            # 7ï¸âƒ£ kubeconfig ì„¤ì • (ë©±ë“±ì„±: ì´ë¯¸ ìˆìœ¼ë©´ ìŠ¤í‚µ)
            # ============================================
            echo ""
            echo "ğŸ”‘ Setting up kubeconfig..."
            
            KUBECONFIG_PATH="/home/${{ secrets.FIRST_USERNAME }}/.kube/config"
            
            if [ ! -f "$KUBECONFIG_PATH" ]; then
              mkdir -p "$(dirname "$KUBECONFIG_PATH")"
              sudo cp /etc/kubernetes/admin.conf "$KUBECONFIG_PATH"
              sudo chown "${{ secrets.FIRST_USERNAME }}:${{ secrets.FIRST_USERNAME }}" "$KUBECONFIG_PATH"
              sudo chmod 600 "$KUBECONFIG_PATH"
              echo "   âœ… Created kubeconfig"
            else
              echo "   âœ… kubeconfig already exists"
            fi
            
            # ============================================
            # 8ï¸âƒ£ ìµœì¢… ê²€ì¦
            # ============================================
            echo ""
            echo "âœ“ Verifying cluster..."
            
            export KUBECONFIG="$KUBECONFIG_PATH"
            
            # kubectl ì„¤ì • í™•ì¸
            if ! kubectl cluster-info &>/dev/null; then
              echo "âŒ Cluster info check failed"
              exit 1
            fi
            
            # ë…¸ë“œ ìƒíƒœ í™•ì¸
            echo "   Nodes:"
            kubectl get nodes -o wide
            
            # ì£¼ìš” í¬ë“œ í™•ì¸
            echo ""
            echo "   System pods:"
            kubectl get pods -n kube-system --no-headers | head -5
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ‰ Kubernetes setup complete!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
