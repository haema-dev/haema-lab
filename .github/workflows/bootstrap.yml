# .github/workflows/bootstrap.yml
name: Install k8s

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      # ===== 1단계: K8s 설치 =====
      - name: Install K8s (kubeadm)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            echo "=== Installing Kubernetes ==="
            
            sudo apt-get update
            sudo apt-get install -y curl gnupg2 software-properties-common
            
            # Kubernetes 리포지토리 추가 (더 안정적인 방법)
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
            
            sudo apt-get update
            sudo apt-get install -y kubelet kubeadm kubectl containerd
            sudo apt-mark hold kubelet kubeadm kubectl
            
            echo "=== Initializing K8s cluster ==="
            sudo kubeadm init --pod-network-cidr=10.244.0.0/16
            
            echo "=== K8s installation complete ==="
            kubeadm version
      
      # ===== 2단계: ArgoCD 설치 =====
      - name: Install ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            export KUBECONFIG=/etc/kubernetes/admin.conf
            
            kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      
      # ===== 3단계: ArgoCD에 GitHub 레포 등록 =====
      - name: Register GitHub Repository in ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            export KUBECONFIG=/etc/kubernetes/admin.conf
            
            # GitHub SSH 키 시크릿 생성
            kubectl -n argocd create secret generic github-ssh \
              --from-literal=sshPrivateKey='${{ secrets.SSH_PRIVATE_KEY_GITHUB }}' \
              --dry-run=client -o yaml | kubectl apply -f -
            
            # ArgoCD가 GitHub 레포를 감시하도록 설정
            cat > /tmp/root-app.yaml << 'EOF'
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
              name: root
              namespace: argocd
            spec:
              project: default
              source:
                repoURL: git@github.com:YOUR_USERNAME/YOUR_REPO.git
                targetRevision: main
                path: cluster/
              destination:
                server: https://kubernetes.default.svc
                namespace: argocd
              syncPolicy:
                automated:
                  prune: true
                  selfHeal: true
                  # ← 이것이 핵심! ArgoCD가 자동으로 Git 변경사항을 감시
            EOF
            
            kubectl apply -f /tmp/root-app.yaml
            
            echo "=== ArgoCD is now watching GitHub repository ==="
            echo "All further deployments will be automatic"
