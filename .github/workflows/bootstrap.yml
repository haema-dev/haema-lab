# .github/workflows/bootstrap.yml
name: Bootstrap (초기 설치만)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }} # Auth keys
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_TOKEN }} # Auth keys

      # ===== 1단계: K8s 설치 =====
      - name: Install K8s (kubeadm)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            if ! command -v kubeadm &> /dev/null; then
              # K8s 설치 로직
              curl -sfL https://raw.githubusercontent.com/.../install.sh | bash
              kubeadm init --pod-network-cidr=10.244.0.0/16
            fi
      
      # ===== 2단계: ArgoCD 설치 =====
      - name: Install ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            export KUBECONFIG=/etc/kubernetes/admin.conf
            
            kubectl create namespace argocd --dry-run=client -o yaml | kubectl apply -f -
            kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
      
      # ===== 3단계: ArgoCD에 GitHub 레포 등록 =====
      - name: Register GitHub Repository in ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e
            
            export KUBECONFIG=/etc/kubernetes/admin.conf
            
            # GitHub SSH 키 시크릿 생성
            kubectl -n argocd create secret generic github-ssh \
              --from-literal=sshPrivateKey='${{ secrets.GITHUB_SSH_PRIVATE_KEY }}' \
              --dry-run=client -o yaml | kubectl apply -f -
            
            # ArgoCD가 GitHub 레포를 감시하도록 설정
            cat > /tmp/root-app.yaml << 'EOF'
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
              name: root
              namespace: argocd
            spec:
              project: default
              source:
                repoURL: git@github.com:YOUR_USERNAME/YOUR_REPO.git
                targetRevision: main
                path: cluster/
              destination:
                server: https://kubernetes.default.svc
                namespace: argocd
              syncPolicy:
                automated:
                  prune: true
                  selfHeal: true
                  # ← 이것이 핵심! ArgoCD가 자동으로 Git 변경사항을 감시
            EOF
            
            kubectl apply -f /tmp/root-app.yaml
            
            echo "=== ArgoCD is now watching GitHub repository ==="
            echo "All further deployments will be automatic"
