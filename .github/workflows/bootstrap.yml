name: Kubespray K8s

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/bootstrap.yml'

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Cleanup K8s
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "üßπ Cleaning up for idempotent deployment..."
            
            # 1. kubeadm Î¶¨ÏÖã
            sudo kubeadm reset --force 2>/dev/null || true
            
            # 2. kubernetes ÏÑ§Ï†ï ÏÇ≠Ï†ú
            sudo rm -rf /etc/kubernetes
            
            # 3. Kubespray Ï∫êÏãú ÏÇ≠Ï†ú
            sudo rm -rf /opt/kubespray/.cache
            sudo rm -rf /opt/kubespray
            
            # 4. Ìè¨Ìä∏ Ï†ïÎ¶¨
            sudo fuser -k -9 6443/tcp 2379/tcp 10250/tcp 10259/tcp 10257/tcp 8080/tcp 2>/dev/null || true
            
            sleep 3
            
            echo "‚úÖ Cleanup complete"

      - name: Setup K8s with Kubespray
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
      
            HOST_IP="${{ secrets.HOST_IP }}"
            USERNAME="${{ secrets.USERNAME }}"
            
            # ÏÇ¨Ïö©Ïûê Ïú†Ï†ÄÎ°ú Ï†ÑÌôòÌïòÎ©¥ÏÑú bash Ïã§Ìñâ
            sudo -u "$USERNAME" -H bash << 'KUBE_SCRIPT'
            set -e
            
            KUBE_VERSION="1.31.6"
            KUBESPRAY_VERSION="v2.29.0"
            KUBESPRAY_HOME="/opt/kubespray"
            VENV_PATH="/opt/venv-kubespray"
            HOST_IP="$HOST_IP"
            USERNAME="$USERNAME"
            
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üîÑ Kubespray Idempotent Setup"
            echo "Kubernetes: $KUBE_VERSION"
            echo "Kubespray: $KUBESPRAY_VERSION"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            
            # ============================================
            # 1Ô∏è‚É£ ÏÉÅÌÉú Ï≤¥ÌÅ¨: Ïù¥ÎØ∏ ÏôÑÏÑ±Îêú ÌÅ¥Îü¨Ïä§ÌÑ∞Ïù∏Í∞Ä?
            # ============================================
            check_cluster_health() {
              if ! command -v kubectl &> /dev/null; then
                return 1
              fi
              
              if ! kubectl cluster-info &>/dev/null; then
                return 1
              fi
              
              READY_NODES=$(kubectl get nodes --no-headers 2>/dev/null | grep -c " Ready " || echo 0)
              TOTAL_NODES=$(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo 0)
              
              if [ "$READY_NODES" -eq "$TOTAL_NODES" ] && [ "$TOTAL_NODES" -gt 0 ]; then
                return 0
              fi
              return 1
            }
            
            if check_cluster_health; then
              echo "‚úÖ Kubernetes cluster is healthy"
              kubectl version --short 2>/dev/null || echo "kubectl available"
              echo "   Nodes: $(kubectl get nodes -o jsonpath='{.items[*].metadata.name}' 2>/dev/null)"
              exit 0
            fi
            
            echo "‚ö†Ô∏è  Cluster health check failed or cluster not initialized"
            echo "   Proceeding with Kubespray..."
            
            # ============================================
            # 2Ô∏è‚É£ ÌôòÍ≤Ω Ï§ÄÎπÑ
            # ============================================
            echo ""
            echo "üì¶ Installing dependencies..."
            sudo apt-get update -qq
            sudo apt-get install -y -qq \
              python3-pip python3-venv git jq curl \
              2>&1 | grep -v "^Processing triggers\|^done\.$" || true
            
            # ============================================
            # 3Ô∏è‚É£ Kubespray Ï§ÄÎπÑ (Î©±Îì±ÏÑ±)
            # ============================================
            echo ""
            echo "üì• Setting up Kubespray..."
            
            if [ -d "$KUBESPRAY_HOME/.git" ]; then
              CURRENT_VERSION=$(cd "$KUBESPRAY_HOME" && git describe --tags 2>/dev/null || echo "unknown")
              if [ "$CURRENT_VERSION" = "$KUBESPRAY_VERSION" ]; then
                echo "   ‚úÖ Kubespray $KUBESPRAY_VERSION already cloned"
              else
                echo "   üîÑ Updating Kubespray from $CURRENT_VERSION to $KUBESPRAY_VERSION"
                cd "$KUBESPRAY_HOME"
                git fetch origin
                git checkout "$KUBESPRAY_VERSION"
              fi
            else
              echo "   üì• Cloning Kubespray..."
              sudo rm -rf "$KUBESPRAY_HOME"
              sudo mkdir -p "$KUBESPRAY_HOME"
              git clone --depth 1 --branch "$KUBESPRAY_VERSION" \
                https://github.com/kubernetes-sigs/kubespray.git "$KUBESPRAY_HOME"
              sudo chown -R "$USERNAME:$USERNAME" "$KUBESPRAY_HOME"
            fi
            
            # ============================================
            # 4Ô∏è‚É£ Python Í∞ÄÏÉÅÌôòÍ≤Ω
            # ============================================
            echo ""
            echo "üêç Setting up Python environment..."
            
            if [ ! -d "$VENV_PATH" ]; then
              python3 -m venv "$VENV_PATH"
              echo "   ‚úÖ Created virtual environment"
            else
              echo "   ‚úÖ Using existing virtual environment"
            fi
            
            source "$VENV_PATH/bin/activate"
            pip install -q --upgrade pip
            pip install -q -r "$KUBESPRAY_HOME/requirements.txt"
            
            # ============================================
            # 5Ô∏è‚É£ Ansible Ïù∏Î≤§ÌÜ†Î¶¨ ÏÑ§Ï†ï
            # ============================================
            echo ""
            echo "üìã Configuring Ansible inventory..."
            
            INVENTORY_DIR="$KUBESPRAY_HOME/inventory/mycluster"
            
            if [ -d "$INVENTORY_DIR" ]; then
              BACKUP_DIR="$KUBESPRAY_HOME/inventory/mycluster.backup.$(date +%s)"
              cp -r "$INVENTORY_DIR" "$BACKUP_DIR"
              echo "   ‚úÖ Backed up existing inventory"
            fi
            
            mkdir -p "$INVENTORY_DIR/group_vars/all"
            
            # hosts.yaml
            cat > "$INVENTORY_DIR/hosts.yaml" <<HOSTS
            all:
              hosts:
                $USERNAME:
                  ansible_connection: local
                  ansible_host: $HOST_IP
                  ip: $HOST_IP
                  access_ip: $HOST_IP
              children:
                kube_control_plane:
                  hosts:
                    $USERNAME:
                kube_node:
                  hosts:
                    $USERNAME:
                etcd:
                  hosts:
                    $USERNAME:
                k8s_cluster:
                  children:
                    kube_control_plane:
                    kube_node:
            HOSTS
            
            # all.yml
            cat > "$INVENTORY_DIR/group_vars/all/all.yml" <<EOF
            kube_version: "1.31.6"
            container_manager: containerd
            dns_mode: coredns
            kube_pods_subnet: 10.244.0.0/16
            kube_service_addresses: 10.96.0.0/12
            kube_apiserver_advertise_address: $HOST_IP
            kube_apiserver_bind_address: $HOST_IP
            
            kubelet_deployment_type: host
            kubeadm_init_timeout: 1800
            upgrade_cluster_setup_timeout: 1800
            skip_kubelet_systemd_environment_file_checks: true
            
            kube_dns_servers:
              - 10.96.0.10
            kubelet_cluster_dns: 10.96.0.10
            kubelet_extra_args: "--cluster-dns=10.96.0.10"
            
            kubeconfig_localhost: false
            kubeconfig_server: "https://$HOST_IP:6443"
            
            containerd_cgroup_driver: systemd
            kubelet_cgroup_driver: systemd
            
            apiserver_cert_extra_sans:
              - "localhost"
              - "127.0.0.1"
              - "$HOST_IP"
              - "kubernetes"
              - "kubernetes.default"
              - "kubernetes.default.svc"
              - "kubernetes.default.svc.cluster.local"
            EOF
            
            echo "‚úÖ Inventory configured"
            
            # ============================================
            # 6Ô∏è‚É£ Kubespray Ïã§Ìñâ
            # ============================================
            echo ""
            echo "üöÄ Running Kubespray..."
            echo "   This may take 15-20 minutes..."
            
            cd "$KUBESPRAY_HOME"
            
            ansible-playbook \
              -i "$INVENTORY_DIR/hosts.yaml" \
              --become \
              --become-method=sudo \
              -e "kubeconfig_localhost=false" \
              -e "kubeconfig_server=https://$HOST_IP:6443" \
              -v \
              cluster.yml
            
            if [ $? -ne 0 ]; then
              echo "‚ùå Kubespray failed"
              exit 1
            fi
            
            echo "‚úÖ Kubespray completed"
            
            # ============================================
            # 7Ô∏è‚É£ kubeconfig ÏàòÏ†ï (kubeadm init Ïù¥ÌõÑ)
            # ============================================
            echo ""
            echo "üîë Patching kubeconfig with HOST_IP..."
            
            if [ -f /etc/kubernetes/admin.conf ]; then
              sed -i "s|server:.*6443|server: https://$HOST_IP:6443|g" /etc/kubernetes/admin.conf
              echo "   ‚úÖ /etc/kubernetes/admin.conf patched"
            fi
            
            if [ -f ~/.kube/config ]; then
              sed -i "s|server:.*6443|server: https://$HOST_IP:6443|g" ~/.kube/config
              echo "   ‚úÖ ~/.kube/config patched"
            fi
            
            # ============================================
            # 8Ô∏è‚É£ kubeconfig Î≥µÏÇ¨
            # ============================================
            echo ""
            echo "üîë Setting up kubeconfig..."
            
            KUBECONFIG_PATH="/home/$USERNAME/.kube/config"
            
            if [ ! -f "$KUBECONFIG_PATH" ]; then
              sudo mkdir -p "$(dirname "$KUBECONFIG_PATH")"
              sudo cp /etc/kubernetes/admin.conf "$KUBECONFIG_PATH"
              sudo chown -R "$USERNAME:$USERNAME" "$KUBECONFIG_PATH"
              sudo chmod 600 "$KUBECONFIG_PATH"
              echo "   ‚úÖ Created kubeconfig"
            else
              echo "   ‚úÖ kubeconfig already exists"
            fi
            
            # ============================================
            # 9Ô∏è‚É£ Shell ÏàòÏ†ï
            # ============================================
            echo ""
            echo "üîß Fixing shell configuration..."
            sudo usermod -s /bin/bash "$USERNAME" || true
            echo "   ‚úÖ Shell fixed"
            
            # üîü ÏµúÏ¢Ö Í≤ÄÏ¶ù
            # ============================================
            echo ""
            echo "‚úì Verifying cluster..."

            export KUBECONFIG="$KUBECONFIG_PATH"

            # kubectl Ïã§Ìñâ ÌõÑ sleep Ï∂îÍ∞Ä
            kubectl get nodes || true
            kubectl get pods -n kube-system --no-headers | head -5 || true

            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "üéâ Kubernetes setup complete!"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

            KUBE_SCRIPT

            sleep 5
            exit 0