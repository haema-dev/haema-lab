name: Cleanup K8s Only

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/cleanup.yml'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v3
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          version: 1.94.1
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ§¹ Complete Cleanup (Remove All K8s)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.FIRST_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ§¹ COMPLETE CLEANUP"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # 1ï¸âƒ£ í¬íŠ¸ ê°•ì œ í•´ì œ (ë¨¼ì €!)
            echo ""
            echo "ğŸ”“ Force releasing ports (priority)..."
            for port in 6443 2379 2380 10250 10259 10257 10251 10252 9099 6783 6784 10256; do
              if sudo lsof -Pi ":$port" -sTCP:LISTEN -t >/dev/null 2>&1; then
                echo "   Releasing port $port..."
                sudo fuser -k -9 "$port/tcp" 2>/dev/null || true
                sudo fuser -k -9 "$port/udp" 2>/dev/null || true
              fi
            done
            sleep 5
            
            # 2ï¸âƒ£ ì„œë¹„ìŠ¤ ì¤‘ì§€
            echo ""
            echo "ğŸ›‘ Stopping services..."
            sudo systemctl stop kubelet kube-apiserver kube-controller-manager kube-scheduler etcd docker containerd 2>/dev/null || true
            sudo systemctl disable kubelet kube-apiserver kube-controller-manager kube-scheduler etcd docker containerd 2>/dev/null || true
            sleep 3
            
            # 3ï¸âƒ£ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            echo ""
            echo "ğŸ’€ Force killing processes..."
            sudo pkill -9 kube-apiserver 2>/dev/null || true
            sudo pkill -9 kube-controller-manager 2>/dev/null || true
            sudo pkill -9 kube-scheduler 2>/dev/null || true
            sudo pkill -9 kubelet 2>/dev/null || true
            sudo pkill -9 etcd 2>/dev/null || true
            sudo pkill -9 containerd 2>/dev/null || true
            sleep 3
            
            # 4ï¸âƒ£ Kubernetes ë””ë ‰í† ë¦¬ ì „ë¶€ ì‚­ì œ
            echo ""
            echo "ğŸ—‘ï¸  Removing Kubernetes directories..."
            sudo rm -rf /etc/kubernetes
            sudo rm -rf /var/lib/kubelet
            sudo rm -rf /var/lib/etcd
            sudo rm -rf /etc/etcd
            sudo rm -rf /etc/ssl/etcd
            sudo rm -rf /opt/etcd*
            sudo rm -rf /opt/cni
            sudo rm -rf /var/run/kubernetes
            sudo rm -rf /etc/cni/net.d
            
            # 5ï¸âƒ£ Kubespray ì‚­ì œ (ìƒˆë¡œ ë°›ê¸° ìœ„í•´)
            echo ""
            echo "ğŸ—‘ï¸  Removing Kubespray..."
            sudo rm -rf /opt/kubespray
            sudo rm -rf /opt/venv-kubespray
            
            # 6ï¸âƒ£ CNI ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë¦¬
            echo ""
            echo "ğŸŒ Cleaning CNI interfaces..."
            for iface in cni0 flannel.1 weave datapath br-* veth*; do
              sudo ip link delete "$iface" 2>/dev/null || true
            done
            
            # 7ï¸âƒ£ containerd ì •ë¦¬
            echo ""
            echo "ğŸ³ Cleaning containerd..."
            if command -v crictl &> /dev/null; then
              sudo crictl rm -a 2>/dev/null || true
              sudo crictl rmi --prune 2>/dev/null || true
            fi
            
            if command -v ctr &> /dev/null; then
              sudo ctr c rm -f $(sudo ctr c list -q 2>/dev/null) 2>/dev/null || true
              sudo ctr i rm -f $(sudo ctr i list -q 2>/dev/null) 2>/dev/null || true
            fi
            
            sudo rm -rf /var/lib/containerd 2>/dev/null || true
            
            # 8ï¸âƒ£ iptables ì´ˆê¸°í™”
            echo ""
            echo "ğŸ”§ Resetting iptables..."
            sudo iptables -F 2>/dev/null || true
            sudo iptables -X 2>/dev/null || true
            sudo iptables -t nat -F 2>/dev/null || true
            sudo iptables -t nat -X 2>/dev/null || true
            
            # 9ï¸âƒ£ IP forwarding í™œì„±í™”
            echo ""
            echo "ğŸ“¡ Enabling IP forwarding..."
            sudo sysctl -w net.ipv4.ip_forward=1 > /dev/null
            
            # ğŸ”Ÿ ë©”ëª¨ë¦¬ ì •ë¦¬
            echo ""
            echo "ğŸ’¾ Freeing memory..."
            sync
            echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
            
            # 1ï¸âƒ£1ï¸âƒ£ ìµœì¢… í¬íŠ¸ í™•ì¸
            echo ""
            echo "âœ“ Final port verification..."
            STUCK_PORTS=""
            for port in 6443 2379 10250; do
              if sudo lsof -Pi ":$port" -sTCP:LISTEN -t >/dev/null 2>&1; then
                STUCK_PORTS="$STUCK_PORTS $port"
              fi
            done
            
            if [ -z "$STUCK_PORTS" ]; then
              echo "   âœ… All critical ports free"
            else
              echo "   âš ï¸  WARNING: Ports still occupied:$STUCK_PORTS"
            fi
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Cleanup complete!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "System ready for fresh K8s installation"
