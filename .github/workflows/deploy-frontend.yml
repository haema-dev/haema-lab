name: "Step 3 [frontend]: Deploy React(Vite) to GHCR"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'apps/frontend/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v4

      # 1. pnpm ì„¤ì¹˜
      - name: ğŸ“¦ Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '10.29.3'
          run_install: false

      # 2. Node.js ì…‹ì—… ë° pnpm ìºì‹œ ì ìš©
      - name: ğŸŸ¢ Set up Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'
          cache: 'pnpm'
          cache-dependency-path: apps/frontend/pnpm-lock.yaml

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° Vite ë¹Œë“œ
      - name: ğŸ”¨ Build Frontend (pnpm + Vite)
        run: |
          cd apps/frontend
          pnpm install
          pnpm run build

      # 4. GHCR ë¡œê·¸ì¸
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: ğŸ³ Build and Push Docker Image
        run: |
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository_owner }}/cloud-frontend" | tr '[:upper:]' '[:lower:]')
          TAG=${{ github.sha }}
          # Dockerfileì€ apps/frontend/ ê²½ë¡œì— ìˆì–´ì•¼ í•¨
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest ./apps/frontend
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

      # 6. K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íƒœê·¸ ìë™ ìˆ˜ì • 
      - name: ğŸ“ Update K8s Manifest
        run: |
          TARGET_FILE="manifests/frontend/frontend-deployment.yaml"
          # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          sed -i "s|image: ghcr.io/.*|image: ghcr.io/${{ github.repository_owner }}/cloud-frontend:${{ github.sha }}|g" $TARGET_FILE
          git add $TARGET_FILE

      # 7. GitOps ì—”ì§„(ArgoCD)ì„ ìœ„í•œ ì»¤ë°‹
      - name: ğŸš€ Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: update frontend image tag to ${{ github.sha }}"
          git push