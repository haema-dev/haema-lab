name: "Step4-gateway: Deploy Spring Cloud Gateway to GHCR"

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'apps/gateway/**' # ê²Œì´íŠ¸ì›¨ì´ ì½”ë“œê°€ ë°”ë€” ë•Œë§Œ ì‘ë™

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write # GHCRì— ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ê¸° ìœ„í•œ ê¶Œí•œ

    steps:
      - uses: actions/checkout@v4

      # 1. Java/Kotlin ë¹Œë“œ (Gradle ì‚¬ìš©)
      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle' # ì´ ì¤„ì„ ì¶”ê°€í•˜ë©´ ë¹Œë“œ ì†ë„ê°€ ë¹„ì•½ì ìœ¼ë¡œ ë¹¨ë¼ì§‘ë‹ˆë‹¤.

      - name: ğŸ”¨ Build with Gradle
        run: |
          chmod +x apps/gateway/gradlew
          ./apps/gateway/gradlew -p apps/gateway clean build -x test

      # 2. GHCR ë¡œê·¸ì¸ (ë³„ë„ Secret í•„ìš” ì—†ìŒ, ìë™ ì œê³µë¨)
      - name: ğŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: ğŸ³ Build and Push Docker Image
        run: |
          IMAGE_NAME=$(echo "ghcr.io/${{ github.repository_owner }}/cloud-gateway" | tr '[:upper:]' '[:lower:]')
          TAG=${{ github.sha }}
          docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest ./apps/gateway
          docker push $IMAGE_NAME:$TAG
          docker push $IMAGE_NAME:latest

      # 4. K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íƒœê·¸ ìë™ ìˆ˜ì • (GitOps í•µì‹¬)
      - name: ğŸ“ Update K8s Manifest
        run: |
          sed -i "s|image: ghcr.io/.*|image: ghcr.io/${{ github.repository_owner }}/cloud-gateway:${{ github.sha }}|g" manifests/apps/gateway/deployment.yaml
          git add manifests/apps/gateway/deployment.yaml

      # 5. ë³€ê²½ëœ íƒœê·¸ë¥¼ Gitì— ì»¤ë°‹ (ì´ê±¸ ë³´ê³  ArgoCDê°€ ì›€ì§ì…ë‹ˆë‹¤)
      - name: ğŸš€ Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add manifests/apps/gateway/deployment.yaml
          git commit -m "chore: update gateway image tag to ${{ github.sha }}"
          git push