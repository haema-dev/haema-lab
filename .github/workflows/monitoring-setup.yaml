name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/monitoring-setup.yaml"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure Fix"
            # 1. ë°©í™”ë²½ ë¹„í™œì„±í™” (í†µì‹  ì¥ì•  ì›ì²œ ì°¨ë‹¨)
            sudo ufw disable || true
            # 2. MTU íŒ¨ì¹˜ (í…Œì¼ìŠ¤ì¼€ì¼ í™˜ê²½ í•„ìˆ˜)
            kubectl patch cm -n kube-system calico-config --type merge -p '{"data": {"veth_mtu": "1220"}}' || true

            echo "ğŸš€ Phase 2: Monitoring Stack (Idempotent Apply)"
            # 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

            # 2. ê·¸ë¼íŒŒë‚˜ ë¹„ë°€ë²ˆí˜¸ ì£¼ì… (ì´ë¯¸ ìˆìœ¼ë©´ ìœ ì§€)
            kubectl create secret generic grafana-admin-credentials \
            -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
            --dry-run=client -o yaml | kubectl apply -f -

            # 3. [í•µì‹¬] í”„ë¡œë©”í…Œìš°ìŠ¤ ìŠ¤íƒ 'ì£¼ë¬¸ì„œ' ë“±ë¡
            # ì´ ë¦¬ì†ŒìŠ¤ ìì²´ê°€ argocd ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆì–´ì•¼ ì•„ë¥´ê³ CDê°€ ì¼ì„ ì‹œì‘í•©ë‹ˆë‹¤.
            cat <<EOF | kubectl apply -f -
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
            name: prometheus-stack
            namespace: argocd
            spec:
            project: default
            source:
                chart: kube-prometheus-stack
                repoURL: https://prometheus-community.github.io/helm-charts
                targetRevision: 81.x.x # 2026ë…„ 2ì›” ìµœì‹  ë²„ì „
                helm:
                values: |
                    grafana:
                    admin:
                        existingSecret: "grafana-admin-credentials"
                        passwordKey: "admin-password"
                    persistence:
                        enabled: true
                        size: 5Gi
                    prometheus:
                    prometheusSpec:
                        retention: 15d
                        storageSpec:
                        volumeClaimTemplate:
                            spec:
                            accessModes: ["ReadWriteOnce"]
                            resources:
                                requests:
                                storage: 10Gi
            destination:
                server: https://kubernetes.default.svc
                namespace: monitoring # ì‹¤ì œ ì„¤ì¹˜ëŠ” ì—¬ê¸°ì—!
            syncPolicy:
                automated:
                prune: true
                selfHeal: true
                syncOptions:
                - CreateNamespace=true
            EOF

            echo "âœ… All blueprints applied. Checking sync status..."