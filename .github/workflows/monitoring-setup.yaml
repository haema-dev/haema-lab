name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4 # [í•µì‹¬] ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“– Read monitoring.yaml
        id: read_file
        run: |
          # 1. íŒŒì¼ ìœ„ì¹˜ë¥¼ ìœ ì—°í•˜ê²Œ ì°¾ìŠµë‹ˆë‹¤ (root, manifests, argocd í´ë” ê²€ìƒ‰)
          TARGET_FILE=$(find . -name "monitoring.yaml" | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "âŒ Error: monitoring.yaml íŒŒì¼ì„ ë¦¬í¬ì§€í† ë¦¬ ì–´ë””ì—ì„œë„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… Found file at: $TARGET_FILE"

          # 2. ë©€í‹°ë¼ì¸ ë³€ìˆ˜ë¥¼ ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
          echo "MONITORING_CONTENT<<EOF" >> $GITHUB_ENV
          cat "$TARGET_FILE" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV # ë§ˆì§€ë§‰ ì¤„ë°”ê¿ˆ ë³´ì¥
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          envs: MONITORING_CONTENT # [ì¤‘ìš”] ë³€ìˆ˜ ì´ë¦„ì„ ì •í™•íˆ ì „ë‹¬
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸš€ Phase 2: Monitoring Stack Deployment"
            
            # 3. [ëƒ‰ì² í•œ ê²€ì¦] ì „ë‹¬ë°›ì€ ë³€ìˆ˜ê°€ ë¹„ì–´ìˆëŠ”ì§€ ì„œë²„ ì¸¡ì—ì„œ í•œ ë²ˆ ë” í™•ì¸í•©ë‹ˆë‹¤.
            if [ -z "$MONITORING_CONTENT" ]; then
              echo "âŒ Error: ì›ê²© ì„œë²„ë¡œ ì „ë‹¬ëœ MONITORING_CONTENTê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!"
              exit 1
            fi
            
            echo "ğŸ“ Received Content Length: ${#MONITORING_CONTENT} characters"

            # 4. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë° ì‹œí¬ë¦¿ ë³´ì¥ (ê¸°ì¡´ ë°ì´í„° ì•ˆì „)
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 5. [í•µì‹¬] ë³€ìˆ˜ ë‚´ìš©ì„ ì£¼ì…í•˜ì—¬ ë°°í¬
            echo "$MONITORING_CONTENT" | kubectl apply -f -

            echo "âœ… Deployment Successful!"
            kubectl get app -n argocd prometheus-stack