name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/monitoring-setup.yaml"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ” Setup Monitoring Secrets"
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            echo "ğŸ“‚ Applying Prometheus Application"
            cat <<EOF | kubectl apply -f -
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
              name: prometheus-stack
              namespace: argocd # ê´€ë¦¬ ì£¼ì²´ëŠ” argocd
            spec:
              project: default
              source:
                chart: kube-prometheus-stack
                repoURL: https://prometheus-community.github.io/helm-charts
                targetRevision: 81.x.x
                helm:
                  values: |
                    grafana:
                      admin:
                        existingSecret: "grafana-admin-credentials"
                        passwordKey: "admin-password"
                      persistence:
                        enabled: true
                        size: 5Gi
                    prometheus:
                      prometheusSpec:
                        retention: 15d
                        storageSpec:
                          volumeClaimTemplate:
                            spec:
                              accessModes: ["ReadWriteOnce"]
                              resources:
                                requests:
                                  storage: 10Gi
              destination:
                server: https://kubernetes.default.svc
                namespace: monitoring # ì„¤ì¹˜ ëª©ì ì§€ëŠ” monitoring
              syncPolicy:
                automated: {prune: true, selfHeal: true}
                syncOptions: [CreateNamespace=true]
            EOF
            echo "âœ… Monitoring Application Registered!"