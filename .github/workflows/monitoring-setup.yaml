name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/monitoring-setup.yaml"
      - "manifests/monitoring.yaml"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure & Storage Fix"
            # 1. ë°©í™”ë²½ ë° MTU í•´ê²°
            sudo ufw disable || true
            kubectl patch cm -n kube-system calico-config --type merge -p '{"data": {"veth_mtu": "1220"}}' || true

            # 2. [ì¶”ê°€] StorageClass ì„¤ì¹˜ (ì´ê²Œ ì—†ìœ¼ë©´ í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ì•ˆ ëœ¹ë‹ˆë‹¤)
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

            echo "ğŸš€ Phase 2: Monitoring Stack (Idempotent Apply)"
            # 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë° ì‹œí¬ë¦¿ ë³´ì¥ (ì´ë¯¸ ìˆìœ¼ë©´ ìœ ì§€ë˜ë¯€ë¡œ ë°ì´í„° ì•ˆì „)
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 2. [ìµœì¢… ë³‘ê¸°] Heredoc ì£¼ì… (404 ì—ëŸ¬ ì™„ë²½ ì°¨ë‹¨)
            # ë”°ì˜´í‘œ('EOF')ë¥¼ ì‚¬ìš©í•˜ì—¬ SSH í™˜ê²½ì—ì„œì˜ ë³€ìˆ˜ í•´ì„ ì˜¤ë¥˜ë¥¼ ë°©ì–´í•©ë‹ˆë‹¤.
            kubectl apply -f - <<'EOF'
            apiVersion: argoproj.io/v1alpha1
            kind: Application
            metadata:
            name: prometheus-stack
            namespace: argocd
            spec:
            project: default
            source:
                chart: kube-prometheus-stack
                repoURL: https://prometheus-community.github.io/helm-charts
                targetRevision: 68.2.1 # ì•„ê¹Œ ìˆ˜ì •í•œ ì•ˆì •í™” ë²„ì „ìœ¼ë¡œ ê³ ì •
                helm:
                values: |
                    grafana:
                    admin:
                        existingSecret: "grafana-admin-credentials"
                        passwordKey: "admin-password"
                    persistence:
                        enabled: true
                        size: 5Gi
                    prometheus:
                    prometheusSpec:
                        retention: 15d
                        storageSpec:
                        volumeClaimTemplate:
                            spec:
                            accessModes: ["ReadWriteOnce"]
                            resources:
                                requests:
                                storage: 10Gi
            destination:
                server: https://kubernetes.default.svc
                namespace: monitoring
            syncPolicy:
                automated:
                prune: true
                selfHeal: true
                syncOptions:
                - CreateNamespace=true
            EOF

            echo "â³ Monitoring Application Sync Status:"
            kubectl get app -n argocd prometheus-stack || echo "âš ï¸ Waiting for ArgoCD to recognize the app..."

            echo "âœ… Monitoring setup applied directly!"