name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/monitoring-setup.yaml"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure Compliance Check"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            # 1. ë°©í™”ë²½: í†µì‹  ì¥ì• ì˜ ê·¼ì› ufw ë¹„í™œì„±í™”
            sudo ufw disable || true
            
            # 2. MTU: Tailscale í™˜ê²½ì— ë§ê²Œ 1220 ê°•ì œ íŒ¨ì¹˜
            kubectl patch cm -n kube-system calico-config --type merge \
              -p '{"data": {"veth_mtu": "1220"}}' || true

            echo "ğŸš€ Phase 2: Declarative Monitoring Setup"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            # 1. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³´ì¥
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

            # 2. ê·¸ë¼íŒŒë‚˜ ë¹„ë°€ë²ˆí˜¸ ì‹œí¬ë¦¿ (ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸)
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 3. [í•µì‹¬] GitHub Raw URLì„ í†µí•œ ì£¼ë¬¸ì„œ(Application) í˜¸ì¶œ
            # ë§ˆìŠ¤í„° ë¸Œëœì¹˜ì˜ ìµœì‹  monitoring.yamlì„ ì§ì ‘ apply í•©ë‹ˆë‹¤.
            RAW_URL="https://raw.githubusercontent.com/${{ github.repository }}/master/argocd/monitoring.yaml"
            
            echo "ğŸ“¥ Fetching blueprint from: $RAW_URL"
            kubectl apply -f $RAW_URL

            echo "â³ Monitoring Application Sync Status:"
            kubectl get app -n argocd prometheus-stack || echo "âš ï¸ Waiting for ArgoCD to recognize the app..."

            echo "âœ… All blueprints applied. Monitoring setup in progress!"