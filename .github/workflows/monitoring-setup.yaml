name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/monitoring-setup.yaml"
      - "manifests/monitoring.yaml"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4 # [í•µì‹¬] ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“– Read monitoring.yaml File
        id: read_file
        run: |
          # íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ í™˜ê²½ ë³€ìˆ˜ì— ë©€í‹°ë¼ì¸ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
          echo "MONITORING_CONTENT<<EOF" >> $GITHUB_ENV
          cat manifests/monitoring.yaml
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          envs: MONITORING_CONTENT # ì½ì–´ì˜¨ íŒŒì¼ ë‚´ìš©ì„ SSH ì„¸ì…˜ìœ¼ë¡œ ì „ë‹¬
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure & Storage Fix"
            sudo ufw disable || true
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

            echo "ğŸš€ Phase 2: Monitoring Stack Deployment"
            # 1. ì‹œí¬ë¦¿ ë³´ì¥ (ê¸°ì¡´ ë°ì´í„° ë³´ì¡´)
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 2. [íŒŒì¼ ì½ê¸° ë°©ì‹] ì „ë‹¬ë°›ì€ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì§ì ‘ ì£¼ì…
            # ì´ ëª…ë ¹ì–´ê°€ ì‚¬ìš©ìë‹˜ì´ ì›í•˜ì‹œë˜ "íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°"ì˜ ì‹¤ì²´ì…ë‹ˆë‹¤.
            echo "$MONITORING_CONTENT" | kubectl apply -f -

            echo "â³ Checking Status..."
            kubectl get app -n argocd prometheus-stack
            kubectl get pods -n monitoring