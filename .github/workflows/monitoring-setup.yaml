name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4 # [í•µì‹¬] ë¦¬í¬ì§€í† ë¦¬ íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“– Read monitoring.yaml
        id: read_monitoring
        run: |
          # 1. íŒŒì¼ ìœ„ì¹˜ ê²€ìƒ‰ ë° í™•ì¸ (argocd/ ë˜ëŠ” manifests/ ë˜ëŠ” root)
          FILE_PATH=$(find . -name "monitoring.yaml" | head -n 1)
          
          if [ -z "$FILE_PATH" ]; then
            echo "âŒ Error: monitoring.yaml íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
          echo "âœ… Found file at: $FILE_PATH"

          # 2. ë©€í‹°ë¼ì¸ ë³€ìˆ˜ ì €ì¥ (ì¤„ë°”ê¿ˆ ë²„ê·¸ ë°©ì§€)
          echo "MONITORING_CONTENT<<EOF" >> $GITHUB_ENV
          cat "$FILE_PATH" >> $GITHUB_ENV
          echo "" >> $GITHUB_ENV # ê°•ì œ ì¤„ë°”ê¿ˆ
          echo "EOF" >> $GITHUB_ENV

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          envs: MONITORING_CONTENT
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure Fix"
            sudo ufw disable || true
            # StorageClassëŠ” í”„ë¡œë©”í…Œìš°ìŠ¤ì˜ ì§‘(ë””ìŠ¤í¬)ì´ë¯€ë¡œ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}' || true

            echo "ğŸš€ Phase 2: Monitoring Stack Deployment"
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
            
            # ë³€ìˆ˜ê°€ ë¹„ì–´ìˆëŠ”ì§€ ë§ˆì§€ë§‰ í™•ì¸
            if [ -z "$MONITORING_CONTENT" ]; then
              echo "âŒ Error: MONITORING_CONTENT is empty!"
              exit 1
            fi
            
            # [í•µì‹¬] ì „ë‹¬ë°›ì€ íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ë°°í¬
            echo "$MONITORING_CONTENT" | kubectl apply -f -

            echo "âœ… Deployment Successful!"
            kubectl get app -n argocd prometheus-stack