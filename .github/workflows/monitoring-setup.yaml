name: "Step 3: Monitoring Stack Setup"
on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - ".github/workflows/monitoring-setup.yaml"

jobs:
  deploy-monitoring:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸŒ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: ğŸ“Š Deploy Prometheus via ArgoCD
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROXMOX_VM_TAILSCALE_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_USERNAME_PRIVATE_KEY }}
          script: |
            set -e
            export KUBECONFIG=$HOME/.kube/config

            echo "ğŸ›¡ï¸ Phase 1: Infrastructure & Storage Fix"
            # 1. ë°©í™”ë²½ ë° MTU í•´ê²°
            sudo ufw disable || true
            kubectl patch cm -n kube-system calico-config --type merge -p '{"data": {"veth_mtu": "1220"}}' || true

            # 2. [ì¶”ê°€] StorageClass ì„¤ì¹˜ (ì´ê²Œ ì—†ìœ¼ë©´ í”„ë¡œë©”í…Œìš°ìŠ¤ê°€ ì•ˆ ëœ¹ë‹ˆë‹¤)
            kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml
            kubectl patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'

            echo "ğŸš€ Phase 2: Monitoring Stack Deployment"
            # 1. ì‹œí¬ë¦¿ ë° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³´ì¥
            kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
            kubectl create secret generic grafana-admin-credentials \
              -n monitoring --from-literal=admin-password='${{ secrets.GRAFANA_PASSWORD }}' \
              --dry-run=client -o yaml | kubectl apply -f -

            # 2. [ìµœì¢… êµì •] Application ë¦¬ì†ŒìŠ¤ ì£¼ì…
            # metadata.namespaceëŠ” ë°˜ë“œì‹œ 'argocd'ì—¬ì•¼ ì•„ë¥´ê³ CDê°€ ì¼ì„ ì‹œì‘í•©ë‹ˆë‹¤.
            kubectl apply -f - <<'EOF'
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
name: prometheus-stack
namespace: argocd
spec:
project: default
source:
    chart: kube-prometheus-stack
    repoURL: https://prometheus-community.github.io/helm-charts
    targetRevision: 68.2.1
    helm:
    values: |
        grafana:
        admin:
            existingSecret: "grafana-admin-credentials"
            passwordKey: "admin-password"
        persistence:
            enabled: true
            size: 5Gi
        prometheus:
        prometheusSpec:
            retention: 15d
            storageSpec:
            volumeClaimTemplate:
                spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                    requests:
                    storage: 10Gi
destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
syncPolicy:
    automated:
    prune: true
    selfHeal: true
    syncOptions:
    - CreateNamespace=true
EOF

            echo "â³ Checking Sync Status..."
            # ì£¼ë¬¸ì„œ í™•ì¸ì€ argocd ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ í•©ë‹ˆë‹¤.
            kubectl get app -n argocd prometheus-stack

            echo "ğŸ“Š Monitoring Pods Status..."
            # ì‹¤ì œ ì¼ê¾¼(Pod) í™•ì¸ì€ monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ í•©ë‹ˆë‹¤.
            kubectl get pods -n monitoring